<!DOCTYPE html>
<html>

<head>
  <meta charset=utf-8 />
  <title>GxE Bavaria 2</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.min.css" >
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
  crossorigin=""/>
  <!-- <link rel='stylesheet' href='css/styles.css' /> -->
  <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>

<style>
.legend-large, .legend-small {
    border-radius: 50%;
}


hr.small, hr.large {
    width: 83px;
    position: absolute;
    top: -8px;
    left: 55px;
    border: 1px dashed #ccc;     /* overwrite assembly.css rule */
    margin-top: 8px;            /* overwrite assembly.css rule */
}

#info {
    z-index: 1000;
}

#grade {
    z-index: 1000;
}

.boys {
    color: #6E77B0;
}

.girls {
    color: #D96D02;
}

body {
    font-family: "Work Sans", sans-serif;
}


</style>    



</head>

<body>
    <div class='flex-parent viewport-full relative scroll-hidden'>
        <div class='flex-child w-full w300-ml absolute static-ml left bottom'>
          <div class='flex-parent flex-parent--column viewport-third h-full-ml hmax-full bg-white py18 px12'>
            <div class='flex-child flex-child--grow px12 py12 scroll-auto'>
              <!-- <h1 class='txt-h2 mb2'>Winter wheat varieties tested in Bavaria (2000-2019)</h1> -->
              <h2 id = "varNames" > Click on a site to see the varieties tested.</h2>

              </div>
            <footer class='px12 py12 bg-gray-faint txt-m'>
              <ul>
                <li><b>Variety data:</b> <a class='link' href="#" target="_blank">whom?</a></li>
                <li><b>Base maps:</b> 
                  <ul> 
                    <li>XXX</li> 
                    <li>YYY</li>
                  </ul>
                </li>
                <li><b>Map authors:</b>
                  <ul> 
                    <li><a class='link' href="https://ykusunose.github.io" target="_blank"> Y. Kusunose</a> (Univ. of Kentucky) </li>
                    <li><a class='link' href="#" target="_blank">M. Gerullis</a> (Universität Bonn) </li>
                  </ul>  
                </li>
              </ul>
            </footer>
          </div>
        </div>
        <div class='flex-child flex-child--grow viewport-twothirds viewport-full-ml'>


          <div id="map" class='viewport-twothirds viewport-full-ml'></div>
          <!-- UI, year indicator, and basemap control go here and floats above the map -->
          <div id='title' class='container  bg-white round-ml border border--gray-light round px12' >
            <h1 class='txt-h2 mb2'>Winter wheat varieties tested in Bavaria (2000-2019)</h1>
          </div>

            <!-- year indicator -->
              <div id='year' >
                <p class='txt-l txt-bold px12'><span></span></p>
              </div>
              
            <!-- ui slider -->
              <div id='slider' class='row  bg-white round-ml border border--gray-light round px12'>
                  <input type="range" min = "2000", max="2019", value="2000", step="1"/>
              </div>

            <!-- basemap contol-->
        
            <div id='basemap' class='container  bg-white round-ml border border--gray-light round px12' >
              <p class='txt-l txt-bold'>Basemap</p>
            <div class="form-check row">
              <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1" value="option1" checked>
              <label class="form-check-label txt-l " for="exampleRadios1">
                None 
             </label>
            </div>
            <div class="form-check row">
              <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2" value="option2">
              <label class="form-check-label txt-l " for="exampleRadios2">
                Agro-ecological zones <a href='#'>info</a>
              </label>
            </div>
            <div class="form-check row">
              <input class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios3" value="option3">
              <label class="form-check-label txt-l " for="exampleRadios3">
                Winter wheat density <a href='#'>info</a>
              </label>
            </div>

            </div>
            
  
        </div>
     </div>

     <!-- ui info panel -->
    <div id='info' class='py6 px12 bg-white border border--gray-light round fixed    w240'>
      <p><span></span></p>
        <p class='girls'>varieties <span></span>: <span class='txt-l txt-bold'></span></p>
        <!-- Additional elements added here for this step! -->
        <!-- <hr class='txt-hr'> -->

    </div>
 

</body>
<script async defer src="https://api.mapbox.com/mapbox-assembly/v0.24.0/assembly.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
  <script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <!-- <script src='js/app.js'></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>

  <script>
  // initialize map, centered on Bavaria
  var map = L.map('map', {
      zoomSnap: .1,
      center: [48.7, 11.4],
      zoom: 6,
      minZoom: 6,
      maxZoom: 9
      //maxBounds: L.latLngBounds([-6.22, 27.72], [5.76, 47.83])
  });

  // mapbox API access Token
  var accessToken = 'pk.eyJ1IjoieWt1c3Vub3NlIiwiYSI6ImNrYmR4YzZhaTA3eGsyeG55MjMwYWVqazgifQ.tghoFjFzgYL0VfaZHuMG_w'

  var deets = document.getElementById("varNames")

  // request a mapbox raster tile layer and add to map
  L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}`, {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'light-v10',
      accessToken: accessToken,
      zoomControl: false
  }).addTo(map);

  bkrOptions = {
    tms: true,
    opacity: 0.7,
    attribution: "stuff here",
    minZoom: 6,
    maxZoom: 9
  };

  var bkrLayer = L.tileLayer('tiles_density/{z}/{x}/{y}.png', bkrOptions).addTo(map);

  $.getJSON("data/trialLocs20yrsVars.json", function (data) {
       drawMap(data);   
  })


  // FXN: drawMap(data)
  function drawMap(data) {
      const options = {
          pointToLayer: function (feature, ll) {
              return L.circleMarker(ll, {
                  opacity: 1,
                  weight: 2,
                  fillOpacity: 0
              })
          }
      }
      const varsLayer = L.geoJson(data, options).addTo(map);
      varsLayer.setStyle({
          color: '#D96D02'
      });
   
      map.fitBounds(varsLayer.getBounds());
      map.setZoom(map.getZoom() -.4)
      resizeCircles(varsLayer, 2000);
      sequenceUI(varsLayer);
  }

  // FXN: resizeCircles (varsLayer, currentYear)
  function resizeCircles(varsLayer, currentYear) {
      varsLayer.eachLayer(function (layer) {
        const radius = calcRadius(Number(layer.feature.properties['vars' + currentYear].length));
        layer.setRadius(radius)
      })
      retrieveInfo(varsLayer, currentYear);
    }
    
  // FXN: calcRadius(val)
  function calcRadius(val) {
      const radius = Math.sqrt(val / Math.PI);
      return radius * 8
  }    

  // FXN: sequenceUI(varslayer)
  function sequenceUI(varsLayer){
      // select slider's input and listen for change
      $('#slider input[type = range]')
          .on('input', function() {
              var currentYear = this.value;
              $('#year span').html(this.value);
              resizeCircles(varsLayer, currentYear)
          })

      const sliderControl = L.control({
          position: 'bottomleft'
      });
      sliderControl.onAdd = function(map) {
          var controls = L.DomUtil.get("slider");
          L.DomEvent.disableScrollPropagation(controls);
          L.DomEvent.disableClickPropagation(controls);
          return controls;
      }
      sliderControl.addTo(map);

      const yearControl = L.control({
        position: 'bottomleft'
      });
      yearControl.onAdd = function(map) {
          var yrControls = L.DomUtil.get("year");
          L.DomEvent.disableScrollPropagation(yrControls);
          L.DomEvent.disableClickPropagation(yrControls);
          return yrControls;
      }
      yearControl.addTo(map);    
     
  }


  const basemapControl = L.control({
          position: 'bottomleft'
      });
      basemapControl.onAdd = function(map) {
          var controls = L.DomUtil.get("basemap");
          L.DomEvent.disableScrollPropagation(controls);
          L.DomEvent.disableClickPropagation(controls);
          return controls;
      }
      basemapControl.addTo(map);


      const titleControl = L.control({
          position: 'topleft'
      });
      titleControl.onAdd = function(map) {
          var controls = L.DomUtil.get("title");
          L.DomEvent.disableScrollPropagation(controls);
          L.DomEvent.disableClickPropagation(controls);
          return controls;
      }
      titleControl.addTo(map);


      // const zoomControl=L.control.zoom({
      //   position: 'bottomright'
      // });
      // zoomControl.onAdd = function(map) {
      //     // var controls = L.DomUtil.get("title");
      //     L.DomEvent.disableScrollPropagation(controls);
      //     L.DomEvent.disableClickPropagation(controls);
      //     return controls;
      // }
      // zoomControl.addTo(map);

  // FXN: retrieveInfo(layer, currentGrade)
  function retrieveInfo(varsLayer, currentYear) {
      
      // select the element and reference with variable
      // and hide it from view initially
      const info = $('#info').hide();

      // since boysLayer is on top, use to detect mouseover events
      varsLayer.on('mouseover', function (e) {

          // remove the none class to display and show
          info.show();

          // access properties of target layer
          const props = e.layer.feature.properties;

          // populate HTML elements with relevant info
          $('#info span').html(props.location);
          $(".girls span:first-child").html(`in ${currentYear}`);
          let numvars = props['vars' + currentYear].length;
          if (numvars==1){
            numvars = 0
          }
          $(".girls span:last-child").html(numvars);

          // raise opacity level as visual affordance
          e.layer.setStyle({
          fillOpacity: .6
          });

          let deetsContent = `<b>${props.location}</b> <p class = girls text-l> ${currentYear}</p>`;

          for (let i = 0; i<numvars; i++) {
            deetsContent += `<br> ${props['vars' + currentYear][i]}`
          }
          if (numvars==0){
              deetsContent += `<br> No record`
            }
          deets.innerHTML = deetsContent;

         
      
      });
      // hide the info panel when mousing off layergroup and remove affordance opacity
      varsLayer.on('mouseout', function(e) {
          
          // hide the info panel
          info.hide();
          
          // reset the layer style
          e.layer.setStyle({
              fillOpacity: 0
          });
      });

      // when the mouse moves on the document
      $(document).mousemove(function(e) {
          // first offset from the mouse position of the info window
          info.css({
              "left": e.pageX + 6,
              "top": e.pageY - info.height() - 25
          });

          // if it crashes into the top, flip it lower right
          if (info.offset().top < 4) {
              info.css({
                  "top": e.pageY + 15
              });
          }
          // if it crashes into the right, flip it to the left
          if (info.offset().left + info.width() >= $(document).width() - 40) {
              info.css({
                  "left": e.pageX - info.width() - 80
              });
          }
      });

  }
  </script>
  </html>